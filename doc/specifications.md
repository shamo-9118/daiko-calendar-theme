# お見積り概算の計算仕様書

本システムでは、既存環境との計算精度の互換性を保つため、以下のアルゴリズムに従って見積り計算を行っています。

## 1. 参照データ

| 変数名 | 参照元 | 説明 |
| :--- | :--- | :--- |
| **定価** | Shopify商品管理画面 | 「価格 (Price)」欄に設定された税別金額 |
| **掛け率（利率）** | メタフィールド (`tier_prices`) | 注文数量に応じたJSONデータの `unit_price` 値 |

---

## 2. 計算ロジック

計算の順序と端数処理（四捨五入・切り捨て）のタイミングは以下の通りです。

### STEP 1：単価の算出（四捨五入）
定価に掛け率を乗じ、1冊あたりの税別単価を算出します。
> **公式**: $定価 \times (掛け率 \div 100)$ → **小数第一位を四捨五入** → **税別単価**

### STEP 2：小計の算出
算出された税別単価に注文冊数を乗じます。
> **公式**: $税別単価 \times 注文冊数 = \mathbf{小計（税別）}$

### STEP 3：消費税の算出（切り捨て）
小計に対して消費税（10%）を算出し、1円未満を切り捨てます。
> **公式**: $小計 \times 0.1$ → **1円未満を切り捨て** = **消費税**

### STEP 4：合計金額の算出
小計と消費税を合算し、最終的な支払金額とします。
> **公式**: $小計 + 消費税 = \mathbf{税込合計金額}$

---

## 3. 計算例（シミュレーション）

**条件**: 定価 `1,494円` / 注文数 `70冊` / 掛け率 `48.9%` の場合

1. **単価算出**: $1,494 \times 0.489 = 730.566$ → **731円**（四捨五入）
2. **小計算出**: $731 \times 70 = \mathbf{51,170円}$
3. **消費税算出**: $51,170 \times 0.1 = 5,117.0$ → **5,117円**（切り捨て）
4. **合計算出**: $51,170 + 5,117 = \mathbf{56,287円}$（税込）
---

## 4. プログラム上の注意点（エンジニア向け）

* **丸め処理**: 合計金額に対して丸め処理を行うのではなく、**「単価」の段階で `Math.round()` を実行**することが、既存システムとの整合性を取るための必須条件です。
* **データ型**: Shopifyから取得する定価は文字列として扱われる場合があるため、計算前に数値型への変換とカンマの除去を行っています。